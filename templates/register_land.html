{% extends 'base.html' %}

{% block title %}{% if edit_mode %}Edit Application{% else %}Register Land{% endif %} — Ndola Land Registry{% endblock %}

{% block head %}
  <!-- Bootstrap & Icons (page-specific extras) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Map & helpers -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">

  <style>
    :root{--brand:#0d6efd;--accent:#198754;--danger:#d00027}
    body{background:#f6f8fb}
    .card{border-radius:12px}
    .required-star{color:var(--danger)}
    .custom-file-label{display:flex;align-items:center;gap:.75rem;border:1px dashed #dee2e6;padding:.75rem;border-radius:8px;background:#fff}
    #map{height:420px;border-radius:8px;border:1px solid #e9ecef}
    @media (max-width:768px) { #map { height: 280px; } }
    
    /* Leaflet layer control styling */
    .leaflet-control-layers {
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
    }
    .leaflet-control-layers-expanded {
        padding: 10px !important;
        background: white;
    }
    .leaflet-control-layers label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        transition: background 0.2s;
        cursor: pointer;
    }
    .leaflet-control-layers label:hover {
        background: #f8f9fa;
    }
    [data-theme="dark"] .leaflet-control-layers {
        background: #2d3748 !important;
        color: #e2e8f0 !important;
    }
    [data-theme="dark"] .leaflet-control-layers label:hover {
        background: #4a5568;
    }
    .search-hint {
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 4px;
    }
    [data-theme="dark"] .search-hint {
        color: #cbd5e0;
    }
    /* payment tiles */
    .pay-tile{cursor:pointer;border:1px solid #e9ecef;padding:1rem;border-radius:10px;background:#fff;transition:all .18s;opacity:0.85}
    .pay-tile:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(13,110,253,.06);opacity:1}
    .pay-tile.selected{border-color:var(--brand);box-shadow:0 8px 18px rgba(13,110,253,.06);opacity:1;background:#f8f9fa}
    .pay-tile img{filter:brightness(0.95);transition:filter .2s}
    .pay-tile:hover img, .pay-tile.selected img{filter:brightness(1)}

    /* accessible hidden for screen readers */
    .sr-only-aria{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* small status overlay */
    .overlay {position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:1055;}
    .spinner-card{background:#fff;padding:1.25rem;border-radius:10px;display:flex;gap:1rem;align-items:center}
    /* card preview */
    .card-preview{background:linear-gradient(135deg,#0d6efd 0%,#198754 100%);color:#fff;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px;min-width:260px;box-shadow:0 8px 20px rgba(13,110,253,.12);transition:transform .25s ease,box-shadow .25s ease}
    .card-preview:focus-within{transform:translateY(-6px);box-shadow:0 18px 30px rgba(13,110,253,.18)}
    .card-number-display{font-family:monospace;letter-spacing:2px;font-size:1.05rem}
    .card-meta{display:flex;justify-content:space-between;font-size:.85rem;opacity:.95}
    .card-logo{height:28px;align-self:flex-end}
  </style>
{% endblock %}

{% block content %}
  <!-- NAVBAR (the site navbar is provided by base.html, but keeping page structure inside content) -->
  <main class="container my-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">

        <!-- Flash messages removed from here - handled by base.html -->

        <form id="landForm" action="{{ url_for('edit_application', app_id=application.id) if edit_mode else url_for('register_land') }}" method="POST" enctype="multipart/form-data" novalidate>

          {% include 'register_land_form_body.html' %}

        </form>
      </div>
    </div>
  </main>

  <footer class="bg-dark text-white py-4">
    <div class="container text-center small">
      &copy; {{ current_year }} Ndola Land Registry — Powered by Ministry of Lands
    </div>
  </footer>

  <!-- Small overlay used during payment processing -->
  <div id="overlay" class="d-none" role="status" aria-live="assertive">
    <div class="overlay">
      <div class="spinner-card">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <div>Processing payment — please wait...</div>
      </div>
    </div>
  </div>

  <!-- Page-specific scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script src="{{ url_for('static', filename='js/register_land.js') }}"></script>
  
  <!-- Form Data Restoration Script -->
  <script>
  // RESTORE FORM DATA AFTER VALIDATION ERROR
  document.addEventListener('DOMContentLoaded', function() {
      {% if form_data %}
      const formData = {{ form_data | tojson | safe }};
      
      console.log('Restoring form data after validation error...');
      
      // Restore all text inputs, textareas, and select elements
      for (const [key, value] of Object.entries(formData)) {
          const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
          
          if (input && input.type !== 'file') { // Don't restore file inputs
              if (input.tagName === 'SELECT') {
                  // For select elements
                  input.value = value;
              } else if (input.type === 'checkbox') {
                  input.checked = (value === 'on' || value === 'true' || value === true);
              } else if (input.type === 'radio') {
                  if (input.value === value) {
                      input.checked = true;
                  }
              } else {
                  // For text, textarea, number inputs
                  input.value = value;
              }
          }
      }
      
      // Re-trigger registration type change to show correct document fields
      const regTypeEl = document.getElementById('registration_type');
      if (regTypeEl && regTypeEl.value) {
          console.log('Triggering registration type change:', regTypeEl.value);
          const event = new Event('change', { bubbles: true });
          regTypeEl.dispatchEvent(event);
          
          // Also update fees
          setTimeout(() => {
              if (typeof updateFeeSummary === 'function') {
                  updateFeeSummary();
              }
          }, 100);
      }
      
      // SCROLL TO FIRST ERROR MESSAGE
      const firstAlert = document.querySelector('.alert-danger');
      if (firstAlert) {
          // Smooth scroll to error
          setTimeout(() => {
              firstAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
          
          // Add pulse animation to highlight the error
          firstAlert.style.animation = 'errorPulse 0.6s ease-in-out 2';
      }
      
      console.log('✓ Form data restored successfully');
      {% endif %}
  });
  
  // Add CSS animation for error highlighting
  (function() {
      const style = document.createElement('style');
      style.textContent = `
          @keyframes errorPulse {
              0%, 100% { 
                  transform: scale(1); 
                  box-shadow: 0 0 0 rgba(220, 53, 69, 0);
              }
              50% { 
                  transform: scale(1.02); 
                  box-shadow: 0 0 20px rgba(220, 53, 69, 0.4);
              }
          }
          
          .alert-danger {
              position: relative;
          }
      `;
      document.head.appendChild(style);
  })();
  </script>
{% endblock %}